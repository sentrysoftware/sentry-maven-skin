# AGENTS.md - AI Coding Agent Instructions

> This file provides instructions for AI coding agents (GitHub Copilot, Cursor, Cline, etc.) to effectively work with the **Sentry Maven Skin** project.

## Project Overview

The **Sentry Maven Skin** is an Apache Maven site skin used to generate modern, beautiful technical documentation websites. It transforms Markdown files into a fully-featured HTML5/Bootstrap website with search, syntax highlighting, and responsive design.

### Key Technologies

This project is a **polyglot mix** of technologies:

| Technology     | Purpose                       | Location                    |
| -------------- | ----------------------------- | --------------------------- |
| **Velocity**   | HTML templating               | `src/main/webapp/*.vm`      |
| **JavaScript** | Frontend logic (AngularJS)    | `src/main/webapp/js/*.js`   |
| **CSS**        | Styling                       | `src/main/webapp/css/*.css` |
| **HTML**       | Angular templates             | `src/main/webapp/*.html`    |
| **Gulp.js**    | Build system for frontend     | `gulpfile.js`               |
| **Maven**      | Build orchestration           | `pom.xml`                   |
| **Groovy**     | Integration test verification | `src/it/*/verify.groovy`    |

### Required Dependency: Maven Skin Tools

The Sentry Maven Skin requires **[maven-skin-tools](https://github.com/sentrysoftware/maven-skin-tools)** (`org.sentrysoftware.maven:maven-skin-tools`) as a companion dependency. This library provides custom Velocity tools that the skin heavily relies on:

- **HTML Processing**: Parses and manipulates the HTML content generated by Maven
- **Search Index Generation**: Builds the ElasticLunr search index using GraalVM JavaScript
- **Image Optimization**: Converts images to WebP format for better performance
- **AI Indexing**: Generates Markdown files for AI platforms (llms.txt)
- **Table of Contents**: Automatically generates navigation from document headings

The skin's Velocity templates (`site.vm`, `tools.vm`) call methods from these tools directly. When working on template code, refer to the [maven-skin-tools documentation](https://sentrysoftware.github.io/maven-skin-tools) to understand available tool methods.

## Project Structure

```
sentry-maven-skin/
├── src/
│   ├── main/webapp/          # Frontend source code
│   │   ├── site.vm           # Main Velocity template (generates each HTML page)
│   │   ├── tools.vm          # Velocity macros and utilities
│   │   ├── css/              # Stylesheets
│   │   │   ├── sentry.css    # Main stylesheet
│   │   │   ├── print.css     # Print-specific styles
│   │   │   └── copy-to-clipboard.css
│   │   ├── js/               # JavaScript files
│   │   │   ├── site.js       # Main AngularJS application
│   │   │   ├── site-index.js # Search index functionality
│   │   │   └── *.html        # AngularJS templates (embedded in JS during build)
│   │   └── fonts/            # Custom fonts
│   ├── it/                   # Integration tests
│   │   ├── settings.xml      # Maven settings for IT
│   │   └── studio-km/        # Test documentation project
│   └── site/                 # Project's own documentation (dogfooding)
├── gulpfile.js               # Gulp build tasks for frontend
├── package.json              # Node.js dependencies
├── pom.xml                   # Maven build configuration
└── target/                   # Build output (generated, gitignored)
    ├── dist/                 # Compiled frontend artifacts
    ├── it/studio-km/         # Integration test execution
    └── local-repo/           # Local Maven repository for IT
```

## Building the Project

### Quick Build

```bash
mvn verify
```

This single command does everything:

1. Installs Node.js locally (in `./node/`)
2. Runs `npm ci` to install dependencies
3. Runs Gulp to build, lint, and minify frontend assets
4. Packages the Maven skin JAR
5. Runs integration tests against a sample documentation project

### Build Output

- **JAR artifact**: `target/sentry-maven-skin-*.jar`
- **Test site**: `target/it/studio-km/target/site/` (HTML output)
- **Build log** (on failure): `target/it/studio-km/build.log`

### Viewing Test Results

To preview the generated test documentation:

```bash
# Install http-server globally (once)
npm install --global http-server

# Serve the test site
http-server target/it/studio-km/target/site
```

Then open http://localhost:8080 in your browser.

## Code Formatting

### JavaScript, CSS, HTML

We use **Prettier** for consistent formatting:

```bash
# Check formatting (CI mode)
npm run format:check

# Auto-fix formatting
npm run format
```

**Configuration**: [.prettierrc.yaml](.prettierrc.yaml)

### JavaScript Linting

We use **ESLint** for JavaScript quality:

```bash
# Check for linting issues
npm run lint

# Auto-fix linting issues
npm run lint:fix
```

**Configuration**: [.eslintrc.yaml](.eslintrc.yaml)

### Velocity Templates

Velocity templates (`*.vm`) don't have automated formatting. Follow these conventions:

1. **Indentation**: Use tabs (not spaces)
2. **Comments**: Use `#* ... *#` for multi-line, `## ...` for single-line
3. **Macros**: Define in `tools.vm`, use in `site.vm`
4. **Whitespace control**: Use `#*...*#` to suppress unwanted whitespace and notably unwanted EOLs

Example of proper Velocity formatting:

```velocity
#**
 * Macro documentation
 **
*##macro(myMacro $param)#*
    *##if ($param)#*
        *#<div>$param</div>#*
    *##end#*
*##end
```

### Editor Configuration

The project includes:

- [.editorconfig](.editorconfig) - Cross-editor settings
- [.vscode/settings.json](.vscode/settings.json) - VS Code specific settings
- [.vscode/extensions.json](.vscode/extensions.json) - Recommended VS Code extensions

## Testing

### Running Tests

```bash
mvn verify
```

The integration test:

1. Builds a real documentation site using the skin
2. Verifies the output with a Groovy script (`src/it/studio-km/verify.groovy`)

### Test Project Location

- **Source**: `src/it/studio-km/` (copied to `target/it/studio-km/` during build)
- **Output**: `target/it/studio-km/target/site/`

### What the Test Verifies

The `verify.groovy` script checks:

- HTML files are generated correctly
- Required assets (CSS, JS, fonts) are present
- No broken links or missing resources

## Making Changes

### Frontend Changes (CSS, JS, HTML)

1. Edit files in `src/main/webapp/`
2. Run `mvn verify` to build and test
3. Preview results in `target/it/studio-km/target/site/`

### Velocity Template Changes

1. Edit `src/main/webapp/site.vm` or `src/main/webapp/tools.vm`
2. Run `mvn verify` to build and test
3. Check generated HTML in `target/it/studio-km/target/site/`

### Adding New Dependencies

**Frontend dependencies** (Bootstrap, AngularJS, etc.):

1. Add to `package.json` under `dependencies`
2. Reference in `site.vm` within `<!-- build:css -->` or `<!-- build:js -->` blocks
3. Gulp will concatenate and minify them

**Build dependencies** (Gulp plugins, etc.):

1. Add to `package.json` under `devDependencies`
2. Require in `gulpfile.js`

## Gulp Build Tasks

| Task                   | Description                      |
| ---------------------- | -------------------------------- |
| `gulp`                 | Full build (default)             |
| `gulp clean`           | Delete build artifacts           |
| `gulp webProd`         | Build and minify JS/CSS          |
| `gulp fonts`           | Copy fonts to dist               |
| `gulp images`          | Copy images to dist              |
| `gulp prismComponents` | Copy PrismJS language components |

## Common Issues & Solutions

### Build Fails with NPM Errors

```bash
# Clear Node.js cache and reinstall
rm -rf node node_modules package-lock.json
mvn verify
```

### Changes Not Reflected in Test Site

Ensure you're running `mvn verify` (not just `mvn package`). The integration test happens during the `verify` phase.

### Velocity Syntax Errors

Check `target/it/studio-km/build.log` for detailed error messages. Common issues:

- Unclosed `#if` blocks
- Missing `#end` directives
- Undefined variables (use `$!variable` for optional variables)

## Code Style Guidelines

### JavaScript

- Use double quotes for strings (enforced by ESLint)
- Use AngularJS 1.x patterns (dependency injection, controllers, services)
- Keep functions small and focused

### CSS

- Use descriptive class names
- Follow Bootstrap conventions
- Use CSS variables for theming (dark/light mode support)

### Velocity

- Keep macros focused and documented
- Use `#call()` macro to ignore return values
- Prefer `$!variable` over `$variable` for potentially null values

## Continuous Integration

The project uses GitHub Actions. The CI workflow:

1. Runs on Ubuntu with pre-installed Node.js
2. Uses the `CI` profile in Maven (skips frontend-maven-plugin, uses system Node.js)
3. Runs `mvn verify` to build and test

## Useful Commands Summary

```bash
# Full build with tests
mvn verify

# Clean build artifacts
mvn clean

# Format code
npm run format

# Check formatting
npm run format:check

# Lint JavaScript
npm run lint

# Fix linting issues
npm run lint:fix

# Serve test site locally
http-server target/it/studio-km/target/site
```

## Files You Should Know

| File                             | Purpose                                   |
| -------------------------------- | ----------------------------------------- |
| `src/main/webapp/site.vm`        | Main HTML template - generates every page |
| `src/main/webapp/tools.vm`       | Velocity macros used by site.vm           |
| `src/main/webapp/js/site.js`     | Main AngularJS application                |
| `src/main/webapp/css/sentry.css` | Main stylesheet                           |
| `gulpfile.js`                    | Frontend build pipeline                   |
| `pom.xml`                        | Maven build configuration                 |
| `package.json`                   | Node.js dependencies and scripts          |

## Getting Help

- **Documentation**: https://sentrysoftware.github.io/sentry-maven-skin
- **Issues**: https://github.com/sentrysoftware/sentry-maven-skin/issues
- **Build logs**: `target/it/studio-km/build.log` (on test failure)
